<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GE-S2DR3 — WebGIS Inference</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin: 0; display: grid; grid-template-columns: 320px 1fr; height: 100vh; font-family: system-ui, sans-serif; }
    #sidebar { background: #111923; color: #eee; padding: 1rem; overflow-y: auto; }
    #map { height: 100%; }
    label { font-size: 0.9rem; display: block; margin-top: 0.5rem; }
    input, textarea, select { width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #333; background: #0e1520; color: #eee; }
    button { margin-top: 0.5rem; padding: 8px; border-radius: 6px; border: none; cursor: pointer; background: #2b6cb0; color: #fff; }
    button:hover { background: #2c5282; }
    .card { background: #0e1520; border: 1px solid #2c3e50; border-radius: 6px; padding: 8px; margin-top: 8px; }
    .status { font-size: 0.8rem; margin-top: 4px; }
    .progress { height: 8px; background: #222; border-radius: 999px; overflow: hidden; margin-top: 6px; }
    .progress > .bar { height: 100%; width: 0%; background: #7cc1ff; transition: width .3s; }
    .progress-msg { font-size: 0.75rem; color: #bbb; margin-top: 4px; }
  </style>
</head>
<body>
  <aside id="sidebar">
    <h2>GE‑S2DR3 WebGIS</h2>
    <label>Commercial User ID (optional)</label>
    <input id="userId" type="text" placeholder="leave empty for trial" />
    <label>Latitude</label>
    <input id="lat" type="text" placeholder="45.4642" />
    <label>Longitude</label>
    <input id="lon" type="text" placeholder="9.1900" />
    <label>AOI size (km, optional)</label>
    <input id="aoiSize" type="text" placeholder="leave empty for trial point mode (trial uses ~4×4 km box)" />
    <small class="muted">Trial notes: point mode processes ~4×4 km around the location.</small>
    <label>Dates</label>
    <textarea id="dates" rows="3" placeholder="YYYY-MM-DD, comma or newline separated"></textarea>
    <label>Product</label>
    <select id="product">
      <option value="TCI">TCI (True Colour)</option>
      <option value="MS">MS (Multispectral)</option>
      <option value="NDVI">NDVI</option>
      <option value="IRP">IRP</option>
    </select>
    <button id="runBtn">Run Inference</button>
    <button id="clearBtn">Clear Overlays</button>
    <h3>Results</h3>
    <div id="results"></div>
  </aside>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    'use strict';

    const CONFIG = {
      API_BASE: "https://s2dr3-job-20250428-862134799361.europe-west1.run.app",
      STATUS_URL: (userId, jobId) => `${CONFIG.API_BASE}/${userId}/${jobId}`,
      TILE_URL: (product, mgrs, sid, pid) => `https://kgbbmarmdgv53gdb47pls2v2oe0qotcs.lambda-url.eu-central-1.on.aws/cog/tiles/WebMercatorQuad/{z}/{x}/{y}@2x?url=s3://sentinel-s2dr3/${mgrs}/${sid}/${pid}/S2L2A_${pid}_${product}.tif`,
      TRIAL_USER_ID: "trial"
    };

    const map = L.map('map').setView([45.4642, 9.19], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors'}).addTo(map);
    const overlays = [];

    function clearOverlays() {
      overlays.forEach(l => map.removeLayer(l));
      overlays.length = 0;
      document.getElementById('results').innerHTML = '';
    }
    document.getElementById('clearBtn').onclick = clearOverlays;

    function addResultCard(date) {
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `<strong>${date}</strong><div class='status'>Queued</div><div class='progress'><div class='bar'></div></div><div class='progress-msg'></div>`;
      document.getElementById('results').prepend(div);
      return div;
    }

    function setCardProgress(card, pct, msg) {
      if (pct != null) { card.querySelector('.bar').style.width = String(pct) + '%'; }
      if (msg) { card.querySelector('.progress-msg').textContent = msg; }
    }

    async function pollJob(userId, jobId, card) {
      let interval = 2000;
      while (true) {
        const resp = await fetch(CONFIG.STATUS_URL(userId, jobId), {cache: 'no-store'});
        if (!resp.ok) { throw new Error(`Job status HTTP ${resp.status}`); }
        const j = await resp.json();
        const state = (j.State || j.status || j.state || '').toString();
        if (state.toLowerCase() === 'completed' || j.done === true) {
          setCardProgress(card, 100, 'Completed');
          return j;
        }
        setCardProgress(card, null, `State: ${state || 'processing'}…`);
        await new Promise(r => setTimeout(r, interval));
        interval = Math.min(6000, interval * 1.2);
      }
    }

    function buildAOI(lat, lon, sizeKm) {
      const side = Number(sizeKm);
      const halfDegLat = (side / 2) / 111.32;
      const halfDegLon = halfDegLat / Math.cos(lat * Math.PI / 180);
      const minx = lon - halfDegLon;
      const miny = lat - halfDegLat;
      const maxx = lon + halfDegLon;
      const maxy = lat + halfDegLat;
      return `${minx} ${miny} ${maxx} ${maxy}`;
    }

    async function runInference(userId, lat, lon, date, product, aoiSize) {
      const card = addResultCard(date);
      try {
        let payload;
        if (!Number.isNaN(Number(aoiSize)) && aoiSize > 0) {
          // commercial (AOI)
          payload = { date: date, aoi: buildAOI(lat, lon, aoiSize) };
        } else {
          // trial (point)
          payload = { date: date, lat: lat, lon: lon };
        }

        const resp = await fetch(`${CONFIG.API_BASE}/${userId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!resp.ok) { throw new Error(`HTTP ${resp.status}`); }
        const data = await resp.json();
        setCardProgress(card, 10, 'Job submitted');

        const status = await pollJob(userId, data.job_id, card);
        const pid = status.PID || status.pid || data.PID || data.pid;
        const mgrs = status.MGRS || status.mgrs || data.MGRS || data.mgrs || (pid ? String(pid).split('-')[0] : null);
        if (!pid || !mgrs) { throw new Error('Missing PID/MGRS in job results'); }
        const sid = String(pid).split('-')[1];
        const url = CONFIG.TILE_URL(product, mgrs, sid, pid);

        const lyr = L.tileLayer(url, { maxZoom: 19, opacity: 0.9 }).addTo(map);
        overlays.push(lyr);
        card.querySelector('.status').textContent = 'Loaded';
        setCardProgress(card, 100, 'Done');
      } catch (err) {
        card.querySelector('.status').textContent = 'Error';
        setCardProgress(card, null, err && err.message ? err.message : String(err));
        console.error(err);
      }
    }

    document.getElementById('runBtn').onclick = async () => {
      const userId = (document.getElementById('userId').value || '').trim() || CONFIG.TRIAL_USER_ID;
      const lat = parseFloat(document.getElementById('lat').value);
      const lon = parseFloat(document.getElementById('lon').value);
      const aoiSizeVal = document.getElementById('aoiSize').value.trim();
      const aoiSize = aoiSizeVal ? parseFloat(aoiSizeVal) : NaN;
      const rawDates = document.getElementById('dates').value;
      const dates = rawDates.split(/[,]+/).map(s => s.trim()).filter(Boolean);
      const product = document.getElementById('product').value;

      if (Number.isNaN(lat) || Number.isNaN(lon)) { alert('Invalid lat/lon'); return; }
      if (!dates.length) { alert('Please enter at least one date'); return; }

      for (const date of dates) {
        // eslint-disable-next-line no-await-in-loop
        await runInference(userId, lat, lon, date, product, aoiSize);
      }
    };
  </script>
</body>
</html>
