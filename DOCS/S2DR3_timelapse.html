<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>S2DR3 Timelapse ‚Äî Minimal Probe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; margin: 1rem; }
    .row { display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 12px; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 12px; }
    label { display: block; font-weight: 600; margin-bottom: 4px; }
    input, select, button { padding: 8px 10px; font-size: 14px; width: 100%; }
    button { cursor: pointer; }
    #msg { margin-top: 8px; color: #333; }
    #thumbs { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px,1fr)); gap: 10px; margin-top: 12px; }
    .thumb { border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
    .thumb img { display:block; width:100%; height:160px; object-fit:cover; }
    .cap { padding:6px 8px; font-size: 12px; background: #fafafa; border-top:1px solid #eee; }
  </style>
</head>
<body>
  <h1>S2DR3 Minimal Date Probe</h1>
  <p>Use this to debug ‚ÄúAdd date‚Äù without any external libraries. Open the browser console to see detailed logs.</p>

  <div class="card">
    <div class="row">
      <div>
        <label for="lon">Longitude</label>
        <input id="lon" type="number" step="0.0001" placeholder="45.023" value="45.023">
      </div>
      <div>
        <label for="lat">Latitude</label>
        <input id="lat" type="number" step="0.0001" placeholder="-20.5228" value="-20.5228">
      </div>
      <div>
        <label for="zoom">Zoom</label>
        <input id="zoom" type="number" min="1" max="19" value="15">
      </div>
      <div>
        <label for="fallback">Zoom fallback</label>
        <div style="display:flex;gap:.5rem;align-items:center">
          <input id="fallback" type="checkbox" checked>
          <span>Allow zoom fallback (12, 10)</span>
        </div>
      </div>

      <div style="grid-column: span 3;">
        <label for="ds">Output ID (ds)</label>
        <input id="ds" type="text" placeholder="MG-T38KMC-e0a95e3ea" value="MG-T38KMC-e0a95e3ea">
      </div>
    </div>

    <div class="row">
      <div>
        <label for="type">Type</label>
        <select id="type">
          <option>RGB</option>
          <option>IRP</option>
          <option>NDVI</option>
        </select>
      </div>
      <div>
        <label for="date">Date (YYYYMMDD)</label>
        <input id="date" type="text" maxlength="8" placeholder="20230816" value="20230816">
      </div>
      <div style="grid-column: span 4; display:flex; align-items:end; gap:10px;">
        <button id="add" type="button">‚ûï Add date (probe & thumbnail)</button>
        <button id="clear" type="button">üóëÔ∏è Clear</button>
      </div>
    </div>

    <div id="msg">Ready. Open DevTools ‚Üí Console for logs.</div>
  </div>

  <div id="thumbs"></div>

  <script>
    // --- Minimal helpers ---
    const lambdaBase = "https://kgbbmarmdgv53gdb47pls2v2oe0qotcs.lambda-url.eu-central-1.on.aws/cog/tiles/WebMercatorQuad";
    const thumbs = document.getElementById("thumbs");
    const msg = document.getElementById("msg");
    const DEBUG = true;

    function setMsg(t){ msg.textContent = t; }
    function validDate(s){ return /^\d{8}$/.test(s); }

    function parseDs(ds){
      const p = (ds||"").split("-");
      return { country: p[0], tile: p[1], uid: p[2] };
    }
    function productSuffix(idx){
      if (idx === "rgb") return "_TCI.tif";
      if (idx === "ndvi") return "_NDVI.tif";
      if (idx === "irp" || idx === "fcir") return "_IRP.tif";
      return "_TCI.tif";
    }
    function tilesFor(country, tile, uid, date, idx){
      const P = `${tile}-${uid}-${date}`;
      const root = `${lambdaBase}/{z}/{x}/{y}@2x?url=s3://sentinel-s2dr3/${country}/${tile}/${P}`;
      const suffix = productSuffix(idx);
      return [`${root}/S2L2Ax10_${P}${suffix}`];
    }
    function lonLatToTile(lon, lat, z){
      const x = Math.floor(((lon + 180) / 360) * Math.pow(2, z));
      const y = Math.floor(((1 - Math.log(Math.tan((lat * Math.PI)/180) + 1/Math.cos((lat * Math.PI)/180)) / Math.PI) / 2) * Math.pow(2, z));
      return { x, y };
    }
    function nice(d){ return `${d.slice(0,4)}-${d.slice(4,6)}-${d.slice(6)}`; }

    // --- Probe one date: try current zoom, then 12, then 10 ---
    function probeDate(ds, idx, date, lon, lat, zoom, allowFallback){
      const { country, tile, uid } = parseDs(ds);
      if (!country || !tile || !uid) {
        alert("ds must be COUNTRY-TILE-UID (e.g., MG-T38KMC-e0a95e3ea)");
        return Promise.resolve({ ok:false });
        }
      const tmpl = tilesFor(country, tile, uid, date, idx)[0];
      const z0 = Math.max(0, Math.round(zoom));
      const zList = allowFallback ? Array.from(new Set([z0, 12, 10])) : [z0];
  
      return new Promise((resolve) => {
        let failures = 0, ok = false;
        zList.forEach(zc => {
          const { x, y } = lonLatToTile(lon, lat, zc);
          const url = tmpl.replace("{z}", zc).replace("{x}", x).replace("{y}", y)
                        + (tmpl.includes("?") ? "&" : "?") + "_cb=" + Date.now();
  
          console.log(`[probe] ${date} ${idx}@z${zc} x=${x} y=${y} ‚Üí`, url);
  
          const img = new Image();
          img.crossOrigin = "anonymous";
          img.onload = () => { 
            console.log("  ‚úÖ loaded");
            ok = true; 
            resolve({ ok:true, url, z: zc, x, y }); 
          };
          img.onerror = () => {
            console.warn("  ‚ùå failed");
            failures++;
            if (failures === zList.length && !ok) resolve({ ok:false });
          };
          img.src = url;
        });
      });
    }

    // --- UI handlers ---
    document.getElementById("add").addEventListener("click", async () => {
      alert("Add handler started");
  
      const lon  = parseFloat(document.getElementById("lon").value);
      const lat  = parseFloat(document.getElementById("lat").value);
      const zoom = parseInt(document.getElementById("zoom").value, 10);
      const ds   = (document.getElementById("ds").value || "").trim();
      const typeUi = document.getElementById("type").value;
      const idx  = (typeUi === "RGB") ? "rgb" : (typeUi === "IRP") ? "irp" : "ndvi";
      const date = (document.getElementById("date").value || "").trim();
      const allowFallback = document.getElementById("fallback").checked;
  
      if (!ds)   { alert("Missing output_id (ds)"); return; }
      if (!/^\d{8}$/.test(date)) { alert("Date must be YYYYMMDD"); return; }
      if (!Number.isFinite(lon) || !Number.isFinite(lat)) { alert("Bad lon/lat"); return; }
      if (!Number.isFinite(zoom)) { alert("Bad zoom"); return; }
  
      setMsg("Probing tiles‚Ä¶ (see Console)");
      const res = await probeDate(ds, idx, date, lon, lat, zoom, allowFallback);
      if (!res.ok) {
        setMsg(`No tiles found for ${idx.toUpperCase()} on ${nice(date)} at z${zoom}${allowFallback ? " (no fallback worked)" : ""}.`);
        return;
      }
  
      setMsg(`Found tiles for ${nice(date)} ‚Äî z${res.z}. Added thumbnail below.`);
      const wrap = document.createElement("div"); wrap.className = "thumb";
      const img = document.createElement("img"); img.src = res.url;
      const cap = document.createElement("div"); cap.className = "cap";
      cap.textContent = `${nice(date)} ‚Ä¢ ${idx.toUpperCase()} ‚Ä¢ z${res.z}`;
      wrap.append(img, cap);
      thumbs.appendChild(wrap);
    });

    document.getElementById("clear").addEventListener("click", () => {
      thumbs.innerHTML = "";
      setMsg("Cleared.");
    });
  </script>
</body>
</html>
